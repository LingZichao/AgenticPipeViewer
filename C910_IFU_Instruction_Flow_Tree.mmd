flowchart TD
    A[Start: PC Register Update] --> B{Fetch Trigger Event?}
    
    B -->|Normal Fetch| C[PC Generator Generates Fetch Address]
    B -->|RTU Flush| FLUSH[PIPELINE FLUSH: Clear IBUF, LBUF, Predictors<br/>Reset Pipeline State<br/>Jump to Correct PC]
    B -->|HAD PC Load| FLUSH
    B -->|IU Control Flow Change| FLUSH
    B -->|Exception/Interrupt| FLUSH
    B -->|Cache Invalidation| FLUSH
    
    C --> D{Cache Hit?}
    D -->|Yes| E[Retrieve Instruction from Cache Data Array]
    D -->|No| F[Initiate Cache Miss Handler/L1 Refill]
    F --> G[Fetch Instruction from Memory]
    G --> H[Store Instruction in Cache]
    H --> E
    
    E --> I[Decode Instruction Type]
    I --> J{Instruction is Branch/Jump?}
    
    J -->|Yes| K{Branch Prediction Check}
    K --> L{BHT: Conditional Branch Prediction}
    L --> M{Predict Taken?}
    M -->|Yes| N{BTB: Get Target Address}
    M -->|No| O[Increment PC by Instruction Size]
    N --> P{L0 BTB: Fast Target Check}
    P --> Q{RAS: Return Address Prediction}
    Q --> R[Update PC with Predicted Target]
    
    O --> R
    R --> S[Pre-decode Instruction]
    S --> T{Check for Exceptions/Misalignment}
    T -->|Valid Instruction| U{Pass Validation Checks?}
    T -->|Invalid Instruction| V[Generate Exception to RTU]
    V --> FLUSH
    
    U -->|Validation Pass| W[Store Instruction in Instruction Buffer]
    U -->|Validation Fail| FLUSH
    
    W --> X{Buffer Full?}
    X -->|No| Y[Add Instruction to Buffer]
    X -->|Yes| Z[Stall Until Space Available]
    Z --> Y
    
    Y --> AA{Check Branch Prediction Accuracy}
    AA -->|Prediction Correct| BB[Prepare Instruction for Delivery to IDU]
    AA -->|Prediction Incorrect| FLUSH
    
    BB --> CC[Format Instruction for IDU Interface]
    CC --> DD[Add Metadata: PC, Branch Info, Exception Flags]
    DD --> EE[Transmit Instruction to IDU]
    EE --> FF[Signal Instruction Ready to IDU]
    FF --> GG[End: Instruction Exits IFU]
    
    I --> HH{Instruction is Return?}
    HH -->|Yes| II{RAS Pop Return Address}
    II --> JJ{Compare with Predicted Address}
    JJ -->|Match| KK[Continue Normal Flow]
    JJ -->|Mismatch| FLUSH
    KK --> W
    
    HH -->|No| LL{Instruction is Call?}
    LL -->|Yes| MM{RAS Push Return Address}
    MM --> NN[Continue Normal Flow]
    NN --> W
    LL -->|No| W
    
    %% Indirect branch handling
    J -->|Yes| OO{Branch is Indirect?}
    OO -->|Yes| PP{Indirect BTB Lookup}
    PP --> QQ[Calculate Target from Register + Offset]
    QQ --> Y
    OO -->|No| K
    
    classDef flushNode fill:#ff6666,stroke:#cc0000,stroke-width:3px
    classDef leafNode fill:#99cc99,stroke:#006600,stroke-width:2px
    classDef normalNode fill:#cceeff,stroke:#0066cc,stroke-width:2px
    classDef decisionNode fill:#fff2cc,stroke:#d6b656,stroke-width:2px
    
    class FLUSH leafNode
    class GG leafNode
    class A,C,E,I,W,Y,BB,CC,DD,EE,FF,K,L,M,N,O,P,Q,R,S,T,U,V,X,Z,AA,KK,LL,MM,NN,HH,II,JJ,LL,MM,NN,OO,PP,QQ normalNode
    class B,J,K,U,X,AA,HH,JJ,LL,OO decisionNode